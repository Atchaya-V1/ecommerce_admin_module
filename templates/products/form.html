{% extends 'base.html' %}
{% block content %}
  <div class="main-header">
    <h3>{{ 'Edit Product' if product else 'New Product' }}</h3>
  </div>
  <form method="post" id="productForm">
    <div class="form-card mb-3">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input name="name" class="form-control" value="{{ product.name if product else '' }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">SKU</label>
          <input name="sku" class="form-control" value="{{ product.sku if product else '' }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Price</label>
          <input name="price" type="number" step="0.01" class="form-control" value="{{ product.price if product else '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Category</label>
          <select class="form-select" name="category_id" id="categorySelect" required>
            <option value="">Select a category</option>
            {% for c in categories %}
              <option value="{{ c.id }}" {% if product and product.category_id==c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
          <div class="help-text">Changing category updates the attribute fields below.</div>
        </div>
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3">{{ product.description if product else '' }}</textarea>
        </div>
      </div>
    </div>

    <div class="form-card">
      <h5 class="mb-3">Attributes</h5>
      <div id="attributesContainer"></div>
    </div>

    <div class="mt-4">
      <button class="btn btn-primary btn-pill" type="submit">Save</button>
      <a class="btn btn-secondary btn-pill" href="{{ url_for('list_products') }}">Cancel</a>
    </div>
  </form>
{% endblock %}

{% block scripts %}
<script>
const valueMap = {
  {% if value_map %}
    {% for k, v in value_map.items() %}
      {{ k }}: {{ v.value|tojson }},
    {% endfor %}
  {% endif %}
};

async function loadAttributes(categoryId) {
  const container = document.getElementById('attributesContainer');
  container.innerHTML = '';
  if (!categoryId) return;

  const res = await fetch(`/api/category/${categoryId}/attributes`);
  const attrs = await res.json();

  for (const a of attrs) {
    const group = document.createElement('div');
    group.className = 'mb-3';

    const label = document.createElement('label');
    label.className = 'form-label';
    label.textContent = a.name + (a.is_required ? ' *' : '');
    group.appendChild(label);

    const name = `attr_${a.id}`;
    let input;
    if (a.data_type === 'boolean') {
      input = document.createElement('select');
      input.className = 'form-select';
      input.name = name;
      input.innerHTML = `<option value="0">No</option><option value="1">Yes</option>`;
    } else if (a.data_type === 'number' || a.data_type === 'decimal') {
      input = document.createElement('input');
      input.type = 'number';
      if (a.data_type === 'decimal') input.step = '0.01';
      input.className = 'form-control';
      input.name = name;
    } else if (a.data_type === 'date') {
      input = document.createElement('input');
      input.type = 'date';
      input.className = 'form-control';
      input.name = name;
    } else if (a.data_type === 'select') {
      input = document.createElement('select');
      input.className = 'form-select';
      input.name = name;
      const options = (a.options || '').split(',').map(s => s.trim()).filter(Boolean);
      input.innerHTML = '<option value="">-- Select --</option>' + options.map(o => `<option value="${o}">${o}</option>`).join('');
    } else if (a.data_type === 'multiselect') {
      input = document.createElement('select');
      input.className = 'form-select';
      input.name = name;
      input.multiple = true;
      const options = (a.options || '').split(',').map(s => s.trim()).filter(Boolean);
      input.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join('');
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control';
      input.name = name;
    }

    if (a.is_required) input.required = true;

    const existing = valueMap[a.id];
    if (existing !== undefined) {
      if (a.data_type === 'multiselect') {
        const items = String(existing).split(',').map(s => s.trim());
        [...input.options].forEach(opt => opt.selected = items.includes(opt.value));
      } else {
        input.value = existing;
      }
    }

    group.appendChild(input);
    container.appendChild(group);
  }
}

const categorySelect = document.getElementById('categorySelect');
categorySelect.addEventListener('change', (e) => loadAttributes(e.target.value));
loadAttributes(categorySelect.value);
</script>
{% endblock %}
